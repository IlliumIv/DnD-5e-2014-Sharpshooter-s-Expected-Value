function addSource(){var e=JSON.parse('[{"i":0,"name":"Base damage","type":"dice","count":"1","dice":"6","canCrit":"yes"}]');e[0].name=window.prompt("Please enter source name:",e[0].name),null!=e[0].name&&restoreSources(e,!1)}function exportCalculation(){var e={Sources:getSourcesJson(),Settings:getSettingsJson()};downloadStringAsFile(JSON.stringify(e),"Sharpshooter's Expected Value "+(new Date).toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})+".txt","text/plain")}function downloadStringAsFile(e,t,a){var r=new Blob([e],{type:a}),n=URL.createObjectURL(r),l=document.createElement("a");l.href=n,l.download=t,l.click(),URL.revokeObjectURL(n)}function importCalculation(){var e=document.createElement("input");e.type="file",e.onchange=e=>{var t=e.target.files[0],a=new FileReader;a.readAsText(t,"UTF-8"),a.onload=e=>{var t=e.target.result,a=JSON.parse(t);localStorage.setItem("Sources",a.Sources),localStorage.setItem("Settings",a.Settings),restoreSettings(),restoreSources(null,!0)}},e.click()}function getSourcesJson(){for(var e=[],t=document.getElementsByClassName("field"),a=0;a<t.length;a++){var r=t[a].querySelector("#field-name").innerHTML,n=t[a].querySelector("#type-selector").value,l={i:a,name:r,type:n,count:"dice"==n?t[a].querySelector("#dice-count").value:1,dice:"dice"==n?t[a].querySelector("#dice-selector").value:t[a].querySelector("#additive").value,canCrit:t[a].querySelector("#can-crit-selector").value};e.push(l)}return JSON.stringify(e)}function getSettingsJson(){for(var e=[],t=document.querySelector("#settings-container").getElementsByClassName("parameter"),a=0;a<t.length;a++){var r=t[a].querySelector("input")??t[a].querySelector("select"),n={i:a,id:r.id,value:r.value};e.push(n)}return JSON.stringify(e)}function save(){localStorage.setItem("Sources",getSourcesJson()),localStorage.setItem("Settings",getSettingsJson())}function restoreSettings(){var e=JSON.parse(localStorage.getItem("Settings"));if(null!=e){var t=document.querySelector("#settings-container");e.forEach((e=>{t.querySelector("#"+e.id).value=e.value}))}}function restoreSources(e,t){e=e??JSON.parse(localStorage.getItem("Sources"))??JSON.parse('[{"i":0,"name":"Base damage","type":"dice","count":"1","dice":"6","canCrit":"yes"}]');var a=document.querySelector("#fields-container");t&&(a.innerHTML="");for(var r=document.querySelector("#field-template"),n=0;n<e.length;n++){var l=document.importNode(r.content,!0);a.appendChild(l),a.lastElementChild.querySelector("#field-name").innerHTML=e[n].name,a.lastElementChild.querySelector("#type-selector").value=e[n].type,renderSourceDamage(e[n].type,a.lastElementChild),a.lastElementChild.querySelector("#can-crit-selector").value=e[n].canCrit,"dice"==e[n].type&&(a.lastElementChild.querySelector("#dice-count").value=e[n].count,a.lastElementChild.querySelector("#dice-selector").value=e[n].dice),"flat"==e[n].type&&(a.lastElementChild.querySelector("#additive").value=e[n].dice)}1==a.childElementCount&&a.lastElementChild.querySelector("#delete-source-button").setAttribute("disabled",""),a.childElementCount>1&&a.firstElementChild.querySelector("#delete-source-button").removeAttribute("disabled"),calculate()}function deleteSource(e){var t=(e.target||e.srcElement).parentElement.parentElement,a=document.querySelector("#fields-container");a.childElementCount>1&&a.removeChild(t),1==a.childElementCount&&a.lastElementChild.querySelector("#delete-source-button").setAttribute("disabled",""),calculate()}function renameSource(e){var t=(e.target||e.srcElement).parentElement.parentElement,a=window.prompt("Please enter source name:",t.querySelector("#field-name").innerHTML);null!=a&&(t.querySelector("#field-name").innerHTML=a,save())}function changeType(e){var t=e.target||e.srcElement,a=t.parentElement.parentElement,r=t.value;a.removeChild(a.querySelector("#damage-container")),a.removeChild(a.querySelector("#can-crit-selector")),renderSourceDamage(r,a),calculate()}function renderSourceDamage(e,t){var a;"dice"==e&&(a=document.querySelector("#dice-damage-template")),"flat"==e&&(a=document.querySelector("#flat-damage-template")),t.appendChild(document.importNode(a.content,!0));var r=document.querySelector("#can-crit-template");t.appendChild(document.importNode(r.content,!0));var n=t.querySelector("#icon");"dice"==e&&(t.querySelector("#yes").setAttribute("selected",""),n.classList.remove("fa-plus"),n.classList.add("fa-dice-d20")),"flat"==e&&(n.classList.remove("fa-dice-d20"),n.classList.add("fa-plus"),t.querySelector("#no").setAttribute("selected",""),t.querySelector("#can-crit-selector").setAttribute("disabled",""))}function getNonCritHitChance(e,t,a){var r=e?15:20;return Math.min(Math.max(r+a-t,0),18)}function expDamage(e,t,a,r){var n=e?10:0;return((a+n)*t+r+n)/20}function getAvgDamage(e,t,a,r){return e?a*(t*("max-plus-dice"==r?3:2)+("max-plus-dice"==r?1:2))/2:a*(1*t+1)/2}function calculate(){for(var e=0,t=0,a=0,r=document.querySelector("#crit-system-selector").value,n=document.getElementsByClassName("field"),l=0;l<n.length;l++){var c=n[l].querySelector("#type-selector").value;if("dice"==c){var o=n[l].querySelector("#dice-selector").value,i=n[l].querySelector("#dice-count").value,u=n[l].querySelector("#can-crit-selector").value;"only"!=u&&(t+=getAvgDamage(!1,o,i,r)),a+=getAvgDamage("yes"==u,o,i,r)}"flat"==c&&(e+=1*n[l].querySelector("#additive").value)}var s=t+e,d=a+e,m=1*document.querySelector("#armor-class").value,g=1*document.querySelector("#attack-bonus").value,S=getNonCritHitChance(!1,m,g),p=getNonCritHitChance(!0,m,g);setValue("#avg-damage-no-feat",s),setValue("#avg-damage-feat",s+10),setValue("#avg-crit-damage-no-feat",d),setValue("#avg-crit-damage-feat",d+10);var v=Math.round(Math.max(S+1,1)/20*100),y=Math.round(Math.max(p+1,1)/20*100),f="=";v>y&&(f=">"),v<y&&(f="<"),setValue("#hit-chance-comparer",f),setValue("#hit-chance-no-feat",v,v>y),setValue("#hit-chance-feat",y,y>v);var h=expDamage(!1,S,s,d),C=expDamage(!0,p,s,d);f="=",h>C&&(f=">"),h<C&&(f="<"),setValue("#expectation-damage-comparer",f),setValue("#expectation-damage-no-feat",h,h>C),setValue("#expectation-damage-feat",C,C>h);var q=getDisableBreakpoint(g,s,d);setValue("#breakpoint-disable-feat",q),setValue("#breakpoint-enable-feat",getEnableBreakpoint(q,g,s,d)-1),save()}function getDisableBreakpoint(e,t,a){for(var r=e-5+1,n=getNonCritHitChance(!1,r,e),l=getNonCritHitChance(!0,r,e),c=expDamage(!1,n,t,a),o=expDamage(!0,l,t,a),i=0;o>c&&i<99;){var u={noFeatExpDamage:c,featExpDamage:o};n=getNonCritHitChance(!1,++r,e),l=getNonCritHitChance(!0,r,e),c=expDamage(!1,n,t,a),o=expDamage(!0,l,t,a),u.noFeatExpDamage<=c&&u.featExpDamage>=o&&i++,u={noFeatExpDamage:c,featExpDamage:o}}return r>=100?NaN:r}function getEnableBreakpoint(e,t,a,r){for(var n=getNonCritHitChance(!1,++e,t),l=getNonCritHitChance(!0,e,t),c=expDamage(!1,n,a,r),o=expDamage(!0,l,a,r);o<c;)n=getNonCritHitChance(!1,++e,t),l=getNonCritHitChance(!0,e,t),c=expDamage(!1,n,a,r),o=expDamage(!0,l,a,r);return e}function setValue(e,t,a){var r=document.querySelector(e);r.innerHTML="",r.innerHTML=t,null!=a&&(r.classList.remove("winner"),1==a&&r.classList.add("winner"))}restoreSettings(),restoreSources(null,!0);